GCP Cloud Architect
---------------------------------
Channels > My Channels > GCP Cloud Architect
22 Hours
List of courses:

# Google Cloud Platform Fundamentals - Core Infrastructure:
 ✓ Introducing Google Cloud Platform
 ✓ Getting Started with GCP
 ✓ Virtual Machines in the Cloud
 ✓ Storage in the Cloud
 ✓ Containers in the Cloud
 ✓ Applications in the Cloud
 ✓ Developing, Deploying and Monitoring in the Cloud
 ✓ Big Data and Machine Learning in the Cloud
 ✓ Summary / review

# Essential Cloud Infrastructure: Foundation
 - Introduction
 - Introduction to GCP
 - Virtual Networks
 - Virtual Machines 
 - Course Resources

# Essential Google Cloud Infrastructure: Core Services
 - Introduction
 - Cloud IAM
 - Storage and Database Services
 - Resource Management
 - Resource Monitoring

# Essential Google Cloud Infrastructure: Scaling and Automation
 - Introduction
 - Interconnecting Networks 
 - Load Balancing and Autoscaling
 - Infrastructure Automation
 - Managed Services
 - Course Resources

# Reliable Google Cloud Infrastructure: Design and Process
 - Introduction
 - Defining Services
 - Microservice Design and Architecture
 - DevOps Automation
 - Choosing Storage Solutions
 - Google Cloud and Hybrid Network Architecture
 - Deploying Applications to Google Cloud
 - Designing Reliable Systems
 - Securing
 - Maintenance and Monitoring
 - Course Resources

# Architecting with Google Kubernetes Engine - Foundations
 - Introduction
 - Introduction to Google Cloud
 - Introduction to Containers and Kubernetes
 - Kubernetes Architecture

# Preparing for the Google Cloud Professional Cloud Architecture Exam
 - Welcome to Preparing for the Professional Cloud Architecture Exam
 - Sample Case Studies
 - Designing and Implementing
 - Optimizing and Operating
 - Resources and next steps



## Links
########################### 

- Professional Cloud Architect Exam Guie
https://cloud.google.com/certification/guides/professional-cloud-architect/

- Professional Cloud Architect Sample Questions
https://cloud.google.com/certification/practice-exam/cloud-architect

- Certification Prep: Professional Cloud Architect
https://cloudonair.withgoogle.com/events/next20-studyjam/watch?talk=w3-talk-4

- Official Google Cloud Professional Cloud Architect Study Guid3e
https://cloudonair.withgoogle.com/events/next20-studyjam/resources

- GCP Free Tier
https://cloud.google.com/free/

- Google Cloud Documentation, ongoing review
https://cloud.google.com/docs/

- Getting Started: Create and Mange Cloud Resources, Skill Badge
https://google.qwiklabs.com/quests/120

- Foundational Infrastructure Tasks, Skill Badge
https://google.qwiklabs.com/quests/118

- Setup and Configure Cloud Environments Skill Badge
https://www.qwiklabs.com/quests/119

- Deploy and Manage Cloud Environments Skill Badge
https://google.qwiklabs.com/quests/121

- Professional Cloud Architecture Sample Questions
https://cloud.google.com/certification/guides/professional-cloud-architect/







##########################################################################
##  Microsoft Azure Solutions Architect: Design for Cost Optimization
##########################################################################
Data does not leave an Azure region unless specifically executed to.


## Designing The Things That Cost Money In The Cloud
##
 - Services: VM (service tier, size, power, etc. )
        1GB RAM / 2 Cores    vs.  32 GB RAM / 16 Cores

 - Storage: Size:  GB, TB, PB,
            Performance Tier:  Hot, Cool Archive

 - Network Traffic:  ingress free, egress $$

 - Software licenses :
    -- could be included in service (Windows VM)
    -- per user: Office 365 License


## Managing and Reporting Costs
##

 - Azure Cost Management & Billing
    - Free tool: analyze costs and manage invoices
    Billing:
        - Invoices
        - Payment methods
        - Billing address
        - Tax ID

    Cost Management:
        - Cost Analysis:  resource type, location, tags, subscription, name, etc.
        - Budgets : set limits on scopes:
              - subscription / resource group
        - Alerts :
        - Connect to AWS : manage costs on both clouds
        - Export billing data

NOTE ON Budgets:
  - can set budget on subscription or resource groups
      - Alerts sent when % of budget hit
      - NO SERVICES STOPPED !!


Spending Limit on Subscription level CAN STOP SERVICES !!!


 - Azure Advisors
  - Gives Recommendations in performance, security, availability and COSTS
    - Recommendations about costs



## Reducing Costs
##

 - General Cost Reductions
 - Discounts
 - Azure spot VMs
 - Reserved Capacity
 - Bring your own license
 - Auto start / stop


 # General Cost Reductions
  - Scale to right sized tiers
  - Create policies
      - created on resource tiers that can be created (basic, etc.)
  - Cleanup unused resources
  - Automatically scale down or in services when not being used

 # Discounts
  - Azure credits for Visual Studio subscribers
  - Use Microsoft managed services provider (MSP)
        - Manages Azure subscription for you
        - Offer discount on Azure services

  - Enterprise Agreement

 # Azure spot VMs
  - can get a discount of upto 90%
  - Azure evicts VM
        - When it needs capacity
        - and/or when VM instance goes over agreed upon price
  - Azure either stops or deletes VM (determined by you)

NOTE: VMs w/ Spot enabled have no SLA (can be stopped at any time)

 # Reserved Capacity
  - reserved capacity for a specific sku
  - 1 to 3 years
  - Reduced price
      - VMs, Storage, Databases, etc.
  - Paid upfront or monthly
      - Cancel or exchange anytime

 # Bring your own license
  - Must have licenses w/ Software Assurance
  - Windows server / SQL Server, etc.

 # Auto Start and Stop

  - Automatically stop on schedule
  - Azure DevTest Labs
  - Azure Kubernetes Service : start / stop cluster
  - Azure Synapse Analytics  : pause and resume compute



## Access Tiers
##
 - Can change access tiers to storage
  - can change individual blobs: Hot, Cool, Archive
  - can change storage account default: Hot or Cool (not Archive)

  - Hot: Fastest and most expensive

  - Cool: store at least 30 days  ***
    - Less expense
    - Cheaper storage costs
    - Higher access costs

  - Archive: store at least 180 days  ***
    - Least expensive
    - slowest (offline storage)
        - hourse to rehydrate
    - cheapest storage costs
    - highest access costs

Can automate via Tracking (version for blobs) and  Lifecycle management
   - rule to move blobs from hot to cool or archive


## Reduce VM Costs
##

 - Spot Tiers
    - Eviction Type:
        - Capacity only
        - Price of Capacity

    - Eviction Policy:
        - Stop / Deallocate
        - Delete

 - Bring Your Own License (BYOL)
    aka Azure Hybrid Benefit
    NOTE: Must have Windows Server License w/ Software Assurance

 - Auto shtudown
    - shutdown during specified times


## Azure Policy
##

 - Create policies to control costs
    - create policy to restrict VM skus
    - assign policy to management or resource group




#################################################################################
##  Microsoft Azure Solutions Architect: Design a Logging and Monitoring Solution
#################################################################################
Data does not leave an Azure region unless specifically executed to.


## Options for Monitoring Applications in Azure
##
# App Level
 - Application Insights
    - part of Azure Monitor (stand alone)
 - Visual Studio App Center                       << App Level
    - Mobile Apps

# Subscription Level
 - Network Watcher
      - Netowrk Traffic
 - Monitor
 - Security Center
 - Advisor
 - Sentinel
      - Works w/ Security Center, looks for threats


## Azure Monitor  +  Application Insights
##

# Monitor
 - Activity Logs
 - Metrics
 - Azure Services
 Drill down to data
 - Kusto query language
 - Workbooks
 - Insights

Automate alert responses

# Azure Application Insights
Use to monitor web and desktop apps in detail

Monitors and alerts on
 - Availability
 - Performance
 - Failures
 - Usage

- Ping and multi-step tests
- Send data to Log Analytics Workspace (datalake)
- Export raw data: JSON format
- Application Map
    - shows dependencies

# Azure Monitor Ecosystem

[Azure    ]      ----+      Azure Monitor Logs      ----+    [Log Analytics]
[Resources]          |        [.........]               |
                     |    Log Analytics Workspace       |    [Dashboards ]
[Applications]       |                                  |
                     |-->                               |--> [Workbooks  ]
[VM Agents]          |                                  |    [Insights   ]
                     |      Azure Monitor Logs          |    [Alerts     ]
[Data Collector]     |         [.........]              |
[ APIs         ] ----+      Time-series data store  ----+    [Metrics Explorer]


# Data Retention
  Application Insights
    - Sends data to Log Analytics Workspace
    - Raw Data up to 730 Days ***
        - Export for more
    - Aggregated Data for 90 Days ***
    - Debug Snapshots for 15 days

  Azure Monitor Logs / Log Analytics Workspace
    - Up to 730 Days ***
    - Export to
        - Storage Account
        - Event Hubs

  Azure Monitor Metrics / Time-series data store
    - for 93 Days ***
    - Performance counters from Log Analytics Agents
        - 31 to 730 Days ***


# Agents
 Windows Agents
  - Azure Monitor Agent
      - Azure: Event, Performance
  - Diagnostics extensions
      - Azure: Event, Performance, file logs, crash dumps
  - Log Analytics Agent
      - Azure / other cloud / on prem: Event, Performance,  file logs
  - Dependency Agent
      - Azure / other cloud / on prem: Process dependency, network, metrics

 Linux Agents
  - Azure Monitor Agent
      - Azure: Syslog, Performance
  - Diagnostics extensions
      - Azure: Syslog, Performance
  - Telegraf Agent
      - Azure / other cloud / on prem: Performance
  - Log Analytics Agent
      - Azure / other cloud / on prem: Syslog, Performance
  - Dependency Agent
      - Azure / other cloud / on prem: Process dependency, network, metrics


## Event Routing
Dashboard > Monitor > Alerts > New alert rule

  - Scope
      - Resource type
      - Specific Resource
  - Condition
      - Signal
      - Alert Logic
  - Actions
      - Action Group
      - Resource Group
      - Notifications
      - Actions
          - Action Group
  - Alert Rule
      - Resource Group
      - Severity


Can use Workbooks to query Log Analytics Workspace
    workbooks = reports that run predefined queries


## Azure Network Watcher
##
  - Monitor and repair network health of IaaS
  - Capture network packet data
  - Network topology
  - Audit network security
  - Regional Service
      - enabled when create virtual network in region

 Diagnostics
  - Diagnose network traffic problem
  - Diagnose network routing problem
  - Capture packets
  - Determine latencies between regions / ISP
  - View security logs for network interface

 Metrics and Logs
  - Analyze traffice to/from NSG
  - View security logs for network resources



## Azure Security Center, Azure Advisor , Azure Sentinel
##

# Azure Security Center
  - monitor and prevent security issues
  - prevent attacks from happening
      - offers recommendations
  - Monitor
      - Security state of services
      - Threats and vulnerabilities

NOTE: works in Azure, on-pre and other clouds

# Azure Advisor
  - get overview of recommendations:
      - Reliability
      - Security
      - Performance
      - Cost
      - Operational Excellence

# Azure Sentinel
  - monitor, analyze, investigate, respond to security issues
  - SIEM: Security Information Event Management  system
  - SOAR: Security Orechestration Automated Response

  Collects data in Log Analytics Workspace
  Detect and analyze incidents
  Hunt for suspicious activities with AI
  Respond to incidents w/ orchestration and automation


# Azure Security Center  vs.  Azure Sentinel

Security Center                           Sentinel
  - Collect & Prevent                       - Collect & Prevent
      - Visibility                              - Visibility
      - Prevent                                 - Prevent
  - Detect                                  - Detect
      - Analytics                               - Analytics
                                                - Hunting
                                            - Investigate
                                                - Incidents
                                            - Respond
                                                - Automation
Security Center
  - Azure Defender (paid monitoring) per resource
      - detection and prevention of security issues

  - Cloud connectors
      - Monitor AWS and GCP Accounts


# Comparing Options for Monitoring in Azure


Monitor a web or   ........................... App Insights
desktop app

Monitor mobile app ............................ App Center

Investigate and
respond to sec. issues  ....................... Azure Sentinel                                                        X

Inspect network Traffic  ...................... Network Watcher

Overview of all
monitoring data   .............................. Azure Monitor

Monitor and prevent
security issue   .............................. Security Center                                          X

Overview of
actionable recommendations  .................... Azure Advisor                                          X                                             X

Sentinel  :  investigate and respond
Sec Center:  monitor and prevent



#################################################################################
##  Exam Alert: Design Monitoring in Microsoft Azure
#################################################################################

## Summary: Design for Cost Optimization
##
  - Azure Cost Management and Billing
    Billing:
        - Invoices
        - Payment methods
        - Billing Address
        - Tax ID

    Cost Management:
        - Cost Analysis
        - Budgets
        - Alerts
        - Connect to AWS

      Policy: to not allow usage of certain tiers
      Reduce Costs:
        - Discounts             - Spot VMs
        - Reserved Capacity     - BYO License
        - Scale In / Down       - Auto Start / Stop

      Spot VMs :
        - Up to 90% discounts
        - Azure Evicts when needs capacity ( or when > agreed price)
        - Stop or Delete VM


  - Azure Advisor

## Summary: Design a Solution for Logging and Monitoring
##
  - Monitoring Apps:
        - App Insights            - App Center  ]--  App Level
        - Network Watcher         - Monitor     ]-
        - Security Center         - Adviso      ] |- Subscription Level
        - Sentinel                              ]-

  # Azure Monitor writes to two areas:
      Log Analytics Workspace / Azure Monitor Logs
      Time-series data store  / Azure Monitor Metrics

# Comparing Options for Monitoring in Azure

Monitor a web or desktop app  ................. App Insights

Monitor mobile app ............................ App Center

Investigate and
respond to sec. issues  ....................... Azure Sentinel                                                        X

Inspect network Traffic  ...................... Network Watcher

Overview of all
monitoring data   ............................. Azure Monitor

Monitor and prevent
security issue   .............................. Security Center                                          X

Overview of
actionable recommendations  ................... Azure Advisor                                          X                                             X

Sentinel  :  investigate and respond
Sec Center:  monitor and prevent



## Design Monitoring "Need-to-know" Exam Information
##

# Focus Cost Optimization

- Azure Cost Management: main cost management service
- Spending Limit != Budget
    - Spending Limit can STOP services
    - Budget alerts on getting close to overages
- Use tags to group resources
- Spot VM has no SLA
- Scale in (to decrease costs)
- Cool tier meant for data stored at least 30 days ***
- Archive tier meant for data stored at least 180 days ***
- Azure pricing calculator


# IGNORE Cost Optimization
  - prices of individual services
  - specific features of cost management + Billing
  - Azure VM SKUs


# Focus Logging and Monitoring
  - Service Options for monitoring and logging
  - What to use when
  - Network Watcher / App Insight provide maps
    - Network Watcher: network topology
    - App Insight    : App dependencies

  - Data store differences
    - Azure Monitor Logs:
        - Logs Analytics Workspace
        - Logs Analytics
        - Kusto Query Language
    - Azure Monitor Metrics:
        - Time series Analytics
        - Metric Explorer

  - Agents:
        - Log Analytics Agent (on-prem and Azure)
        - Telegraf Agent is linux specific for performance
        - Both TO BE REPLACED BY:  Azure Monitor Agent
Retention Times:

# Data Retention
  Application Insights
    - Raw Data up to 730 Days ***
    - Aggregated Data for 90 Days ***
    - Debug Snapshots for 15 days

  Azure Monitor Logs / Log Analytics Workspace
    - Up to 730 Days ***

  Azure Monitor Metrics / Time-series data store
    - for 93 Days ***
    - Performance counters from Log Analytics Agents
        - 31 to 730 Days ***

# IGNORE Logging and Monitoring
    - what data is logged
    - details of service features
    - Kusto query lang
    - monitoring logging costs




#################################################################################
##  Microsoft Azure Solutions Architect: Introduction to the AZ-304 Exam
#################################################################################

## Microsoft Certification Path
##

## Azure Solutions Architect Expert Certification
##
  - design and implement Azure solution
      - compute, storage, network, sec auth/auth, HA/DR, basic devops procs


## AZ-303 vs. AZ-304
##
  - Pass both for cert
  - AZ-303: Focus on implementation
  - AZ-304: Focus on design


## AZ-304 Key Themes
##
  - Architect complete solutions
      - Requirements
      - Interactions
      - Limit / Optimizations
      - Resiliency
      - Authentication
      - Monitoring and Operations

## Preparing for AZ-304
##

## Review of Required Knowledge
##

## AZ-304 Functional Groups
    - Design monitoring            : 10 - 15 %
    - Design identity and security : 25 - 30 %
    - Design data storage          : 15 - 20 %
    - Design business continuity   : 10 - 15 %
    - Design infrastructure        : 25 - 20 %

## Design Monitoring
  - Design for cost optimization
  - Design solution for logging / monitoring

## Design Identity and Security
  - Design authentication
  - Design authorization
  - Design governance (policies, tagging)
  - Design security for application

## Design Data Storage
  - Design a solution for databases
  - Design data integration
  - Select an appropriate storage account

## Design Business Continuity
  - Design a solution for backup and recovery (RPO, RTO)
  - Design for high availability

## Design Infrastructure
  - Design a compute solution
  - Design a network solution
  - Design an application architecture
  - Design migrations





#################################################################################
##  Microsoft Azure Solutions Architect: Design Authentication
#################################################################################

## Azure Active Directory Refresher
  - Azure Active Directory is an enterprise identity provider
  - Global Available
  - Utilizes a flat structure
        - allows users, groups other objects to be created
  - Cloud authentication protocols instead of Kerberos, NTLM



## Azure AD High Level View

                            [   Microsoft         ]<------->[Microsoft Apps]
  [Active Directory]<------>[   Azure             ]
  [Domain Services ]        [   Active            ]<------->[Non-Microsoft Apps]
                            [   Directory         ]<------->[On Prem Apps]


## Populating Azure AD
  - Azure AD supports various types of objects
  - Accounts are often synced from AD
  - Azure AD Connect used w/ optional password hash sync ***
      - provides users w/ SSO experience
  - Cloud Groups can contain synced users
  Password Hash is a hash of the hash
    - per user salt
    - 1000 HMAC-SHA256 iterations

# Benefits of Password Hash in Azure
  - Break Glass: if primary auth method is compromised switch to cloud auth
  - Smart Lockout: will lockout Azure AD account and not AD account
  - Breach Replay Protection:  check for credentials on web

## Azure AD Connect
  - can selectively replicate objects based on Org Units (OUs)
  - group filtering available (non-prod)
  - optionally replicate hash of password hash
  - replicates on 30 min interval, password change then every 2 min
  - Only one instance of AAD Connect can be replicating.
        - stage / stand by


  [ AD ] =====>> [ AAD Connect ] =====>> [ Azure AD ]


## Azure AD Modern Authentication Options
##
  - Cloud Only (authentication performed in Azure AD)
  - Hybrid (certain authenication operations utilize non-Azure AD )
        i.e. Domain Controllers / Federation

NOTE: Cloud Only is only option that enables global scale and resiliency

## Cloud Only Authentication
##
  - Requires password has option to be enabled in Azure AD Connect
  - Username and password is sent to Azure AD
  - Authentication is performed natively in Azure AD utilizing stored password hash
  - Organization AD NOT involved in auth flow
  Considerations:
  ---------------
    - Has auto-defense capabilities and smart lockout
    - Account locked out in AD, can still be used in Azure AD
    - Account disabled in AD may take up to 30 min to be reflected in Azure AD
    - Expired password in AD will not block use in Azure AD
    - Time restrictions for the AD account are not implemented for Azure AD

## Hybrid Authentication
##

# Pass Through Authentication (PTA)
  - Username and password sent to Azure AD but the password is validated
     against Active Directory

      - leverages an agent that looks for auth requests from Azure AD and
         authenticates against AD
      - multiple auth agents can be deployed
      - can be deployed as part of Azure AD Connect deployment
      - Agent establishes outbound connection over 443 to Azure AD
         removing need for open ports / DMZ
      - Does not require password hashes to be stored in Azure AD
      - Can support multiple forests (?) w/ forest trusts

  [ user ] <---> [ AAD ] <---> [ pass-thru auth agent ] <---> [ AD ]


# Federations
  - Username and password sent to federated services which then
     enables the authentication

      - Orgs had federation services to enable SSO to cloud services from on-prem
      - only way to enable SSO
      - support for on-prem policies, 3rd Party MFA, cert based authentication
NOTE:
    - possible to federate between on-prem and Azure AD
    - if app federations have moved to Azure AD, a lot of infrastructure
    - only initial authentication would go to federation
    - All other service access utilizes refresh token in Azure AD per OAuth


## Choosing an Authentication Method
##
  - no cost element in Azure AD for which method used
  - can take advantage of Conditional Access
  - hashes in Azure AD for break glass option
preference:
  1. Cloud authentication w/ password hash
  2. Pass-through authentication
  3. Federation

https://docs.microsoft.com/en-us/azure/active-directory/hybrid/choose-ad-authn


## SSO
  - Same Sign-on: user has to type credentials
  - Seamless Sign-on: Passowrd hash and PTA
  - Single Sign-on: Federation
  - Seamless and Single provide same end-user experience for users on
      corporate device on corporate network


## Azure AD Connect Health
##
  - Available as part of Azure AD Premium P1 and above
  - Provides comprehensive health
      - AD via an agent on domain controllers
      - ADFS via an agent on federation servers
  - Agents can be configured to auto update
  - Has notification options to send email in the event of problems



Home > Azure Active Directory Connect Health


## Azure AD B2B
##

- Partners own id can be added as a known guest identity and given
permissions to resources

    - guest is still using their own identity
    - authentication happening against their source provider
        - Azure AD
        - Microsoft Account
        - Google identity (GMail)
        - Direct Federation (SAML/WS-FED)
        - OTP  (One Time Password)

- Guests are invitded and then redeem the invite
    - can be bulk added via PowerShell, portal solutions, entitlement management

NOTE: Azure AD Premium features extend using a 5:1 ratio to
      B2B users, e.g. for every 1 Premium AAD user, can be extended
      to 5 B2B users.


# Entitlement Management
  - enables key rsources to be packaged and made available
    via access packages

  - Users and guests can request an access package
  - Access package can include:
      - AAD security group membership
      - Ofice 365 group and team membership
      - SharePoint Online site membership
      - Enterprise app assignment

  - Access packages are organized into catalogs
  NOTE: Azure AD P2 feature


## Controlling Azure AD Authentication and User Experience
##

# Azure AD Multi-Factor Authentication (MFA)
  - something i know:  passowrd or pin
  - something i have:  phone or laptop
  - something i am  :  biometrics

- Part of Azure AD Premium
  - can be integrated w/ conditional access

- Azure AD MFA available for Office apps / management part of Ofice 365

- Azure AD MFA free for all Global Admins
  - available for free as part of security defaults

Azure Acive Directory > Properties > Manage Security defaults
    > Enable Security defaults [Yes]
      - will disable legacy authentication
      - make admins use MFA
      - makes users register for MFA in 14 days
      - prompts users to use MFA for heightened risk (??)
      - Can only use authenticator application

Methods: Utilizes users phone
  - Call
  - Text
  - Authenticator app via a code or approval notification


Azure Active Directory > Security > MFA > Configure
    > Additional cloud-based MFA settings
NOTE: NOT Manage MFA Server

    - app passwords
    - trusted ips
    - verification options
          - call to phone
          - Test message to phone
          - Notification through mobile app
          - Verification code from mobile app or hardware token

- Support for OATH-compatible TOTP (time-based token)
   that show a code
- Can support on-prem services via NPS (Network Policy Server) extension
   to support RADIUS
- 3rd party cloud-based MFA can be integrated
    i.e. Conditional Access

# End User MFA Registration
- User will be forced to register for MFA when accessing a server
  that requires it

Use Conditional Access for heightened access w/ MFA
  - Conditional Access has built-in policy to enable MFA for admins

Azure Active Directory > Security > Conditional Access  | Policies
  - MFA for GAs accessing Azure Portal if not AAD joined
      - Global Admin Role
      - Azure Management
      - Grant Access:
            - Require MFA
            - Require device to be marked as compliant
            - Require Hybrid Azure AD joined device
            - Require protected client apps
      Cloud Apps or actions > User Actions > Register security information

https://aka.ms/MFAsetup

Azure AD Identity Protection (P2)
  - includes policy to require MFA registration for selected users


# Life of a Token

[Client]                [Azure AD]                [Service]
   -------------------------------------------------->

[RT][AT]<------------  [Realm Discovery] <-------------

   --------------------------------------------------> [AT]

   ------------------------>[RT]

[RT][AT]<-----------------------

   --------------------------------------------------> [AT]

# Life of a Token on Another Service
[Client]                [Azure AD]                [Service 2]
   ------------------------>[RT]

[RT][AT2]<----------------------

   --------------------------------------------------> [AT2]

[ST]<--------------------------------------------------

   --------------------------------------------------> [ST]

RT=Refresh Token
AT=Access  Token (short lived, 60 min)
NOTE: Refresh Token has a rolling window / doesn't expire
  Once Authenticated, use Refresh Token for initial service and subsequent services


# Conditional Access

  - P1 feature w/ P2 required for user risk integration (????)
  - Authorization but can be tied to stronger Authentication
    i.e Must use MFA
  - Can use locations / terms of use

Azure Active Directory > Security > Conditional Access | Policies
    > Named locations
        - Set of IP address (NAT Gateway, etc.)
            - Ranges of IP Address can be marked as "Trusted"
        - Countries / Regions

Azure Active Directory > Security > Conditional Access | Policies
    > Terms of Use
        - PDF Document
        - Terms of Use displayed and user has to accept to move forward


Can Report Only Conditional Access to see what would happen before enabling
specific Conditional Access


Azure Active Directory > Security > Conditional Access | Policies
    > What If
    - What if scenarios for Conditional Access configurations
      - shows which policies would and would not apply

# Using Conditional Access
  - Policies can be enabled or disabled
  - What If enables impact of policy to be evaluated
  - If multiple policies apply then all requirements must be met
  - Careful of all users / all cloud apps
      - Have excluded group of admins
      - Bypass group
  - Policies apply to all, including B2B


# End User Self-Service
 myapplications.microsoft.com

 - end user starting point
 - AKA My Apps
 - Provides access to assigned apps, group mgmt, My Account, My Access
 - My Apps extension for browsers (why??)

Azure Active Directory > User settings > Manage user feature preview settings
    > Users can use preview features for My Apps
        [None   Selected   All]


 - Self-service Password Reset
  - enable users to reset
  - password reset portal / challenges
  https://passwordreset.microsoftonline.com
      - Office Phone
      - Mobile Phone
      - Alternate email
      - Security Questions

Azure Active Directory > Password reset | Properties
    > Authentication methods
        - # of methods required to reset [ 1   2 ]
            - Mobile app code
            - Email
            - Mobile Phone
            - Office Phone
            - Security Questions
              - # of questions to register  [3    4    5]
              - # of questions to reset     [3    4    5]
              - Predefined / Custom

    > Registration
        - Require users to register when signing in  [Yes    No]


# Combined Security Registration
  - Combined sec reg unifies MFA and Self-service password reset

Azure Active Directory > User Settings > Manage user feature preview settings
    > Users can use the combined security information registration experience
        [None     Selected      All]



#################################################################################
##  Microsoft Azure Solutions Architect: Design Authorization
#################################################################################


## Authentication (AuthN) and Authorization (AuthZ)
## 


Authentication (AuthN):
    - Proving a pincipal really is that principal
    - Users, Service Principals, Applications, Resources, etc.

Authorization (AuthZ):
    - Controlling what a principal can do
    - Fine and Coarse grained
        Coarse:  Can access application
        Fine  :  Can access specific actions on specific objects
                      - Enforced within app or service
                      - RBAC within Azure Resource Manager


## Authentication in Azure AD
## 
- Various levels of authorization that apply to Azure AD
    - User consent for applications  that integrated w/ Azure AD 
          - OAuth 2.0:  get authorization on users behalf for access

    - Authorization of actions against Azure resources and Azure AD
          - Subscription, Azure Resource Manager (ARM)

    - Follow principal of Least Privilege and Just In Time

Least Privilege:  Giving only the permission to perform the required function
                    - minimum rights on minimum scope
                    minimizes bad actors

Just In Time   :  Have heightened permissions only when needed
                    - multiple roles for needed permissions

## Resource Structure in Azure
## 

- Can only auth to 1 Azure AD
- Managemement Groups have 1 auth
- Subscription can only live in 1 Mgmt Grp
- Create Resource Groups under Subscription 
- Create Resources under a Resource Group

Authorization by granting Roles (actions, permissions) 
to security principals (users, groups)  at a scope
          scope:   Management Groups
                   Subscriptions 
                   Resource Groups 
                   or even Resource (not advised)


                         Azure Resource Structure


                                                  ┌───────────┐
Policy  -------│   │                              │ Azure AD  │   Only 1 Azure AD
               │   │  I                           └───────────┘
Cost Mgmt      │   │
               │   │  N
 RBAC     │    │   │                                   ┌──────┐     
  │       │    │   │  H                                │ Root │     _
  │       │    └───┼─────────────────────────────────> └──────┘     │
  │       │        │  E                                             │
  │       │        │                             ┌────┐   ┌────┐    │ Management
  │       │        │  R                          │ MG │   │ MG │    │
  │       │        │                             └────┘   └────┘    │ Groups
  │       │        │  I                                             │
  │       └────────┼───────────────────> ┌────┐  ┌────┐  ┌────┐     │
  │                │  T                  │ MG │  │ MG │  │ MG │     │
  │                │                     └─┬──┘  └────┘  └──┬─┘     _
  │                │  A                    │                │       
  │                │                 ┌─────┴─────┐          │
  │                │  N              │           │          │       _
  └────────────────┼────────────>  ┌─┴─┐        ┌┴──┐     ┌─┴─┐     │
                   │  C            │ S │        │ S │     │ S │     │ Subscriptions
                   │               └─┬─┘        └───┘     └───┘     │  (sub in only 1 MG)
                   v  E              │                              _
                                     │                              
        ┌────────────────────────────┴───────────────────┐
        │                                                │          _
        │  ┌────┐  ┌────┐  ┌──────────────────────────┐  │          │
        │  │ RG │  │ RG │  │                       RG │  │          │ Resource
        │  └────┘  └────┘  │ ┌────┐        ┌────┐     │  │          │
        │                  │ │ R  │        │ R  │     │  │          │ Groups
        │                  │ └────┘        └────┘     │  │          │
        │                  │       ┌────┐             │  │          │
        │                  │       │ R  │             │  │          │
        │                  │       └────┘             │  │          │ (R)esource
        │                  └──────────────────────────┘  │          _
        └────────────────────────────────────────────────┘

NOTE: Role inherited down to resources 
  from Managemement Group > Subscription > Resource Group > Resource 



## Resource Groups
## 

- Resource Groups fundamental to ARM
- Natural grouping of resources 

Benefits:
1. Group resources that share a common lifecycle
2. RBAC is commonly applied at resource group level (get inherited down) 
3. Policies can be applied at the resource group level
4. Can configure tags (not inherited to container resources)
      - policy can be written to write tag from resource group to resource

NOTE: Resources exist within one and ONLY ONE Resource Group which cannot be nested

Resource Groups are NOT:
  - Boundaries of access
  - Not confined to a region 
        - When creating a Resource Group you set a region 
            but that is where meta data is stored

+-------------------------------------------------------+
|    +----------------+            +----------------+   |
|    |                |            |                |   |
|    |                |            |                |   |
|    |                |            |                |   |
|    +-Resource Group-+            +-Resource Group-+   |
|        /                                              |
+-------/-----------------Subscription------------------+
       /Scope                   ^
      /                         |
     /                          |
  [Role]--------Assigned To-----|
     |
     |
      -----Assigned To-----> [Group]




## Azure AD Role Management
## 

## Azure AD Roles

- Azure AD is a flat structure 
- Roles are Azure AD wide
- Administrative Units allow scoping supported by some roles
    - place users and groups into an Admin Unit
    - Give a Role at the scope of the Admin Unit 

- Custom Roles possible but in preview

NOTE: To assign role to a group, special cloud group must be used.
      Roles are usually assigned to users. 


Cloud Group has "is assignable to role property" (?)
  - New Group > Azure AD roles can be assigned to the group (Preview): [yes]
  - Global Admin and Role Admins can manage membership of group
  - Credentials of members and owners of Role Assignable group
      can only by changed by Authentication Administrator or Global Admin
  NOTE: Can't nest Role Assignable groups



## Azure Roles (ARM)

- Large number of built-in roles
- Three core roles apply to all resources
    - Owner
        - full owner to change and delegate
    - Contributor 
        - create and manage resources but can't change ACLs 
    - Reader

NOTE: Other roles specific to certain type of Azure resource
      Many different types of roles in a Resource Group becuase a 
      Resource Group can own any type of resource

NOTE: However a Storage Account would have fewer number of roles becasue 
      those roles would be specific to Storage Account resource 

NOTE: Focus on assigning permissions to groups rather than users
      Permissions are inherited 
      Management Group > Subscription > Resource Group  


## Role Structure

Resource Provider
  - Can register in Subscription

[Resource Provider]
      |
      |
      |---[Resource #1 Definition]
      |      |- Read / Write / Delete
      |      |- Others
      |
      |---[Resource #2 Definition]
      |      |- Read / Write / Delete
      |      |- Others
      |
      |
      |
      |

Subscription > Contributor > Permissions > Compute > 
Virtual Machines 
  - Read  : Get Virtual Machine
  - Write : Create or Update Virtual Machine
  - Delete: Delete Virtual Machine
  - Other Actions:
      - Assess virtual machine for OS update
      - Cancel install OS update
      - Deallocate Virtual Machine
      - Power off Virtual Machine
      ......

## Custom Structure

- Custom roles can be created where built-in roles 
  do not meet requirements
- Specific actions for types of resources 
- With code using an existing role and modify

Resource Group > IAM > Roles > Add > Custom Roles
  Clone a role
  Start from scratch
  Start from JSON file
  > Role to Clone > 
      - Add Permissions
      - Exclude Permissions

  > Assignable Scope
      - Subscription
      - Resource Group



## Role Assignment

  - Assign roles to groups, then add users to group 
  - Group granted role at a specific scope
            - Management Group, Subscription, Resource Grp


## Privileged Identity Management

  - P2 feature
  - Enable just-in-time elevation
      - right to elevate up permanently or for period of time
  - Users can elevate for a fixed duration after additional 
     authenication i.e. MFA
  - Integration w/ ticketing and approval workflow

> Azure Portal > Privileged Identity Management > Role setting details > 

[Activation]   
  duration
  activiation required (MFA)
  justification
  ticket
  approval

[Assignent]  
  allow permanent eligible assignment 
    expire after:
  allow permanent active assignment 
    expire after:
  require MFA
  require justification

[Notificaiton]
Send notification when members are assigned as eligible
Send notification when members are assigned as active

> Azure Portal > Privileged Identity Management > Resources
    - Resource Group
    - Subscription
    - Management Group 
      > Settings > Roles > Edit 

  > Add Assignment 
  > Role 
  > Members
  > Settings 

[Assignent]  
  Type: [Eligible] [Active] 
  Assignment Starts: 
  Assignment Ends: 


## Access Reviews
  - recertify assignments by admins, reviewers, end users self cert
  - special capabilities for guest access
  - can group reviews into a program (i.e. for an audit )
  - P2 feature

> Privileged Identity Managemement >  Azure AD Roles > Manage
  > Access Reviews
        - Name
        - Start / End
        - Frequency
        - Scope (Users)
        - Role
        - Reviewers


> Azure Active Directory >  Identity Governance > Access Reviews
  - Members of a Group
    Assigned to an application


User goes to: 
myaccess.microsfot.com > Access Reviews 


## Identity Protection
- P2 feature 
- Provides insight into security of Azure AD identities 
- Integrates w/ cyber security to look for compromised accounts
- Utilizes machine learning 
- User and sign-in risk (offline / online)
- Enables risk-based conditional access

Portal > Azure AD Identity Protection
or use Azure AD portal: aad.portal.azure.com

  - User risk policy
  - Sign-in risk policy
  - MFA registration policy



#################################################################################
##  Microsoft Azure Solutions Architect: Design Governance
#################################################################################

## Governance in Azure 
## 

# Resource Structure in Azure 

- Can only auth to 1 Azure AD
- Managemement Groups have 1 auth
- Subscription can only live in 1 Mgmt Grp
- Create Resource Groups under Subscription 
- Create Resources under a Resource Group

Authorization by granting Roles (actions, permissions) 
to security principals (users, groups)  at a scope
          scope:   Management Groups
                   Subscriptions 
                   Resource Groups 
                   or even Resource (not advised)


                         Azure Resource Structure


                                                  ┌───────────┐
Policy  -------│   │                              │ Azure AD  │   Only 1 Azure AD
               │   │  I                           └───────────┘
Cost Mgmt      │   │                                      |
               │   │  N                                   |
 RBAC     │    │   │                                   ┌──────┐     
  │       │    │   │  H                                │ Root │     _
  │       │    └───┼─────────────────────────────────> └──────┘     │
  │       │        │  E                                             │
  │       │        │                             ┌────┐   ┌────┐    │ Management
  │       │        │  R                          │ MG │   │ MG │    │
  │       │        │                             └────┘   └────┘    │ Groups
  │       │        │  I                                             │
  │       └────────┼───────────────────> ┌────┐  ┌────┐  ┌────┐     │
  │                │  T                  │ MG │  │ MG │  │ MG │     │
  │                │                     └─┬──┘  └────┘  └──┬─┘     _
  │                │  A                    │                │       
  │                │                 ┌─────┴─────┐          │
  │                │  N              │           │          │       _
  └────────────────┼────────────>  ┌─┴─┐        ┌┴──┐     ┌─┴─┐     │
                   │  C            │ S │        │ S │     │ S │     │ Subscriptions
                   │               └─┬─┘        └───┘     └───┘     │  (sub in only 1 MG)
                   v  E              │                              _
                                     │                              
        ┌────────────────────────────┴───────────────────┐
        │                                                │          _
        │  ┌────┐  ┌────┐  ┌──────────────────────────┐  │          │
        │  │ RG │  │ RG │  │                       RG │  │          │ Resource
        │  └────┘  └────┘  │ ┌────┐        ┌────┐     │  │          │
        │                  │ │ R  │        │ R  │     │  │          │ Groups
        │                  │ └────┘        └────┘     │  │          │
        │                  │       ┌────┐             │  │          │
        │                  │       │ R  │             │  │          │
        │                  │       └────┘             │  │          │ (R)esource
        │                  └──────────────────────────┘  │          _
        └────────────────────────────────────────────────┘

NOTE: Role inherited down to resources 
  from Managemement Group > Subscription > Resource Group > Resource 



# Naming Standards 
- Have standard that is used on prem and across clouds
- Should include:
      - location
      - env
      - app
      - purpose
      - resource type


# Tags
  - metadata on resources w/ key - value
        - all resources except Management Groups
  - 50 tags per resource ***
    - search
    - organization
    - filter / costs


  - Common tags:
    - cost center / biz unit
    - app / func / env / owner
    - classification / compliance
    - could add JSON document in value

NOTE: Enforce using Azure Policy
    - apply a Policy to a Subscription to enforce certain tags


NOTE: Tags are NOT inherited but can be copied from a parent 
       to a child via Policy

Built-in policy:  Inherit a tag from the resource group if missing
      - inherit a tag from the subscription
      - inherit a tag from the resource group


# Using Azure Policy
  - Azure Policy can assess compliance and enforce requirements
  - Policies consist of rules 
  - Rules based on resource Properties
  - Effects:
      - Audit
      - Deny
      - Append
      - Modify
      - DeployIfNotExists (missing agent, etc.)
  - Policies can be grouped into initiatives
        - Initiative can then be assigned to Resource Group, 
              Subscription, Managemement Group

NOTE: Enforced at fabric level: CLI, API, REST doesn't matter


Initiative Example:
Azure > Policy > Initiative > 
   Enable Monitoring in Azure Security Center [123 policies] 


# Assigning Policies

Azure > Policy > Assignments
      > Assign Initiative
      > Assign Policy


# Viewing Compliance 


Azure > Policy > Policy Compliance   

# Best Practices

  - Map policies to org written policies
  - Use audit before deny / remediate
  - Apply to right level of structure and start small
          NOTE: Don't apply restricitive policy to Management Group

  - Broad policy toward top of structure, detailed policy closer to resource
  - Have team responsible for tracking compliance
  - Use good names / descriptions 



## Applying Base Configurations with Bluprints
## 




















.
